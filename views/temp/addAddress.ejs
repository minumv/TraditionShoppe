<%- include('../layout/authheader') %>
//////////////////////////
<% if (errorMessage.length > 0) { %>                
    <div id="errorMessageDiv" class="alert alert-danger mt-3" role="alert"> <%- errorMessage %>  </div>                
                     <script>                                
                       setTimeout(function() {
                          var errorMessageDiv = document.getElementById("errorMessageDiv");
                          if (errorMessageDiv) {
                              errorMessageDiv.style.display = "none";
                          }
                      }, 4000); 
                  </script>
  <% } %>
  <% if (successMessage.length > 0) { %>                
    <div id="successMessageDiv" class="alert alert-success" role="alert"> <%- successMessage %>  </div>                    
    <script>                                
      setTimeout(function() {
         var successMessageDiv = document.getElementById("successMessageDiv");
         if (successMessageDiv) {
          successMessageDiv.style.display = "none";
         }
     }, 4000); 
 </script>
    <% } %>
/////////////////
function handleFileInputChange(event) {
    
    // const files = event.target.files;
    // if (files && files.length > 0) {
    //     const file = files[0]; 
    //     const reader = new FileReader(); 
        
    //     reader.onload = function(e) {
    //         previewDiv.style.visibility = 'visible';
    //         preview.src = e.target.result;
    //     };        
    //     reader.readAsDataURL(file);
    // }}

    const files = event.target.files; // Get the selected files
    console.log("files :",files);
    // Iterate through each file
   
    for (let i = 0; i <= files.length; i++) {
        const reader = new FileReader(); // Create a new FileReader instance

        // Define a callback function to handle the FileReader's onload event
        reader.onload = function(event) {
            const imgSrc = event.target.result; // Get the base64 data URL of the image
            const imgIndex = i + 1; // Index of the image (e.g., img1, img2, etc.)
            const inputImgId = `inputImg${imgIndex}`; // ID of the input image element
            const imgElement = document.getElementById(inputImgId); // Get the input image element

            // Set the src attribute of the input image element to display the preview
            imgElement.src = imgSrc;
            imageArray.push(imgSrc)

            // Show the image container
            const imgContainerId = `imgdiv${imgIndex}`;
            document.getElementById(imgContainerId).style.visibility = 'visible';
           console.log("CALLING", i)
            initializeCropperForImage(i+1);
        };
       
        reader.readAsDataURL(files[i]);
        
    }
  }

  const croppers = [];

  function initializeCropperForImage(inputIndex) {
    const imageId = `inputImg${inputIndex}`;
    console.log(imageId);

    const imageElement = document.getElementById(imageId);

    // Ensure the image is loaded before getting dimensions
    imageElement.onload = () => {
    // Get original dimensions of the image
    const originalWidth = imageElement.naturalWidth;
    const originalHeight = imageElement.naturalHeight;

    console.log(`Original Dimensions for ${imageElement}:`, originalWidth, originalHeight);

    let cropper = new Cropper(imageElement, {
        // Add Cropper.js options here
        aspectRatio:1/1
        
    });
    console.log(`cropper${imageId} :`,cropper);

    // Save cropper instance
    // croppers.push(cropper);
    croppers[inputIndex - 1] = cropper;
    console.log('croppers :',inputIndex ,":",croppers)
  }
  if (imageElement.complete) {
      console.log("image",imageElement)
        imageElement.onload();        
    }
  }

  

  let form = document.getElementById('profile_form')
  let formData = new FormData(form);

    // Display form data in console for testing
   
  form.addEventListener('submit',function(event){
    event.preventDefault()
   
  //  for (let i = 0; i < croppers.length; i++) {
    croppers.forEach((cropper, index) => {
      console.log("getcanvas",cropper)
      if (!cropper || !cropper.originalDimensions) {
            console.error(`Original dimensions not set for cropper ${index}`);
            return;
        }
      const { originalWidth, originalHeight } = cropper.originalDimensions;
        
        cropper.getCroppedCanvas({
          width:  160,
          height: 90,
      }).toBlob(function(blob){
          console.log(`Cropped image ${index + 1}:`, blob);
          appendCroppedImageToForm(blob)
      })
    });
  })


  function  appendCroppedImageToForm(blob){  
    
    let form = document.getElementById('profile_form');
    console.log("form: ",form)
    let formData = new FormData(form)
    for (var pair of formData.entries()) {
        console.log(pair[0] + ': ' + pair[1]);
        
    }
    console.log("blob :",blob)
    formData.append('croppedImage',blob);
    console.log("crr",formData.croppedImage)
    console.log("formdata: ",formData)
    console.log('Form data length:', formData.size); // Check the size property
console.log('Form data keys:', formData.keys()); // Log the keys
for (const key of formData.keys()) {
    console.log(key + ':', formData.get(key));
}
console.log('Form data:', formData);
    console.log('Blob:', blob);


$.ajax('/uploadPdtImage', {
  method: 'POST',
  data: formData,
  processData: false,
  contentType: false,
  success() {
    console.log("uploaded")
    location.href='/admin/products'
  },
  error() {
    location.href='/newProducts'
    console.log('Upload error');
  },
});
  }
  
////////////////////////////
<body>
<div class="container">
	<div class="d-flex justify-content-center h-100">
		<div class="card" style="height: 470px;">
			<div class="card-header">
				<h3>Sign Up</h3>
				<!-- <div class="d-flex justify-content-end social_icon">
					<span><i class="fab fa-facebook-square"></i></span>
					<span><i class="fab fa-google-plus-square"></i></span>
					<span><i class="fab fa-twitter-square"></i></span>

 						 <% if (errorMessage.length > 0) { %>                
                                        <p style="color : red;"><%- errorMessage %></p>                    
                                    <% } %>
                                    <% if (successMessage.length > 0) { %>                
                                        <p style="color : green;"> <%- successMessage %> </p>                   
                                    <% } %>


										invalid feedback color   :  #ed1557
										purple : #4F0341
										green : #00bfa5

										.................
										 <% let offerprice = 0 %>
                      <% if( pdt.pdtoffer !== 0 && pdt.categoffer !== 0 ){ %>
                        <% if( pdt.pdtoffer >= pdt.categoffer ){ %>
                          <% offerprice =  pdt.pdtoffer %>
                        <%} else {%>
                          <% offerprice =  pdt.categoffer %>
                        <%}%>
                      <%} else if( pdt.pdtoffer === 0 && pdt.categoffer !== 0 ){%>
                        <% offerprice =  pdt.categoffer %>
                      <%} else if( pdt.pdtoffer !== 0 && pdt.categoffer === 0 ){%>
                        <% offerprice =  pdt.pdtoffer %>
                      <%}%>
                      <% let salesprice = pdt.discountedPrice - offerprice  %>
					  ................


					  /****************order***************/
					  <%orders.forEach((odr)=>{%>
    <%users.forEach((usr,index)=>{%>
                
        <% if(usr._id.equals(odr.user)){%>
   
    <div class="d-block border rounded ord-box ">
        <div class="ord-header d-flex bottom-line p-2">
            <div class="detal d-block">
                <p class="text-dark text-uppercase mb-0">Order placed:</p>
                <p><%= odr.order_date%></p>
            </div>&nbsp;&nbsp;&nbsp;
            <div class="detal d-block mx-4">
                <p class="text-dark text-uppercase mb-0">Total:</p>
                <p><%= odr.payment_amount%></p>
            </div>&nbsp;&nbsp;&nbsp;
            
            <div class="detal d-block mx-4">
                <p class="text-dark text-uppercase mb-0">Payment Method:</p>
                <p><%= odr.payment%></p>
            </div>
            <%address.forEach((adr,index)=>{%>
                <%console.log("inside address")%>
                <% if(adr._id.equals(odr.address)){%>
                    <div class="detal d-block mx-4">
                        <p class="text-dark text-uppercase mb-0">Ship To:</p>
                        <p><%=adr.name%>,<%=adr.house%>,<%=adr.city%></p>
                    </div>
                <%}%>
            <%})%>
            

        </div>
        <div class="ord-body d-block bottom-line p-1">
           <div class="d-flex">
            <!-- after checking -->
            <!-- <p class="text-dark fs-3 font-weight-bold mb-0">Expected Delivery:</p>
            <p><%= odr.delivery_date%></p>
           </div>
          
            
                    <%odr.product_list.forEach((list)=>{%>
                        <%products.forEach((pdt)=>{%>
                            <%if(list.productId.equals(pdt._id)){%>
                                <div class="d-flex"> 
                                    <div class="ord-pdt d-flex">
                                    <div class="">
                                        <img src="../upload/<%=pdt.images[0]%>" class="pdt-img rounded border" >
                                    </div>
                                   
                                <div class="pdt-det d-block border mb-2 p-2 rounded">
                                    <p class="font-weight-bold mb-0" style="color:#4F0341"><%=pdt.product_name%></p>
                                    <p>Return window closed on <%= odr.return_date%></p>
                                    <div class="d-flex">
                                        <p class="text-dark text-uppercase mb-0">Order placed:</p>
                                        <p><%= odr.order_date%></p>
                                    </div>
                                    <div class="d-flex">
                                        <p class="text-dark fs-3 font-weight-bold mb-0">Expected Delivery:</p>
                                        <p><%= odr.delivery_date%></p>
                                    </div>
                                    <div class="d-flex">
                                        <p class="text-dark text-uppercase mb-0">Payment Method:</p>
                                        <p><%= odr.payment%></p>
                                    </div>
                                    <a href="/viewProduct/<%= pdt._id %>"><button class="use-but ord-but bg-warning text-center text-dark">Buy Again</button></a>
                                    <a href="/review"><button type="submit" class="use-but ord-but bg-light text-center text-dark">Write a review</button></a>
                                </div>
                                <div>

                                </div>
                            
        </div>
        <div class="ord-addrs"></div></div>

        </div>
        <div class="ord-status d-block p-1">
            <div class="d-flex">
                <p class="text-dark fs-3 font-weight-bold">Status:</p>
                <p class="text-success fs-3 font-weight-bold"><%= odr.orderstatus%></p>
            </div>
            <div class="d-flex">
                <%console.log("orderid: "+odr._id)%>
                <form action="/cancelRequest/<%= odr._id %>" method="post"><button type="submit" class="use-but ord-but bg-white text-dark">Cancel Order</button></form>
                <form action="/returnRequest/<%= odr._id %>"  method="post"><button type="submit" class="use-but ord-but bg-white text-dark">Return Product</button></form>
            </div>
                        <%}%>
                        <%})%>
                    <%})%>
            
        </div>
    </div>

        <%}%> 
    <%})%> 
<%})%> 
</div> 

////////

        // const cartDet = await Cart.aggregate([
        //     { $match:{
        //         _id : objectId
        //     }},
        //     {
        //         $lookup : {
        //             from : 'addresses',
        //             localField : 'user',
        //             foreignField : 'user_id',
        //             as : 'useraddress'
        //         }
        //     },
        //     {
        //         $unwind: {
        //             path: "$useraddress",
        //             preserveNullAndEmptyArrays: true  // Preserve documents where the array is empty or null
        //         }
        //     },
        //     {
        //         $addFields: {
        //             useraddress: {
        //                 $cond: [
        //                     { $eq: [{ $type: "$useraddress" }, "missing"] },  // Check if useraddress is missing
        //                     null,  // Set to null if missing
        //                     "$useraddress"  // Otherwise, keep the original value
        //                 ]
        //             }
        //         }
        //     }
//////////////


<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>

$('#returnbut').click(function() {
    alert("button clicked")
    alert("order",orderid)
    // Get selected values from dropdowns
    const reason = $('#returnreason').val();         
    console.log("reason:"+reason);
    
    
    // Send selected values to server
    $.ajax({
       url: '/getReturnReason', // Change this URL to match your server route
       method: 'POST',
       data: {
           returnReason : reason            
       },
       success: function(response) {
           // Handle success response
           console.log('Server response:', response);
           requestReturn(orderid)
          // addressSubmission();
       },
       error: function(xhr, status, error) {
           console.error('Error:', error);
       }
    });
    });

    ................
    <% if (row.adminaction === 'delivered'){ %>
                        <span class="badge badge-sm bg-gradient-success">delivered</span>
                    <% } else if(row.adminaction === 'approve') { %> 
                        
                        <%console.log("pdtid:",pdtid,qty,user._id,row._id)%>
                        <form action="/orderPending/<%=row._id%><%=pdtid%>/<%=user._id%>/<%=qty%>" method="post"><button  type="submit" class="badge badge-sm bg-gradient-warning">approve</button>  </form>                      
                    <% } else if(row.adminaction === 'order cancelled') { %> 
                        <form action="/cancelapprove/<%=row._id%>" method="post"><button type="submit" class="badge badge-sm bg-gradient-danger">order cancelled</button> </form>
                    <% } else if(row.adminaction === 'approve return') { %> 
                        <form action="/returnapprove/<%=row._id%>" method="post"><button  type="submit" class="badge badge-sm bg-gradient-warning">approve return</button></form>                  
                    <% } else if(row.adminaction === 'refund granted') { %> 
                       <span class="badge badge-sm bg-gradient-success">refund granted</span>  
                    <% } %>
........................................
<div class="d-flex justify-content-center">
                        <div class="dropdown mx-3">
                            <select id="adminaction">
                              <option value="Apply">Apply</option>
                              <option value="approve">approve</option>
                              <option value="to pack">to pack</option>
                              <option value="to dispatch">to dispatch</option>
                              <option value="to ship">to ship</option>
                              <option value="approve cancel">approve cancel</option>
                              <option value="arrived">arrived</option>
                              <option value="approve return">approve return</option>
                            </select>
                        </div>
                        <button id="actionbut" type="button" class="use-but ord-but bg-white text-dark"  onclick="handleRequest('<%=row._id%>,<%=pdtid%>,<%=user._id%>,<%=qty%>')">ok</button>
                    </div> 
                    
                    ..........
                    formaction="/makeOrder/<%=userid%>/<%=defaultPayment%>"
                       <%if((cart.useraddress === null)){%>
                                    <a href="#" id="openModal" data-modal-target="#modal"><span class="icon icon-plus d-flex">&nbsp;<p>Add new address</p></span></a>
                                <%} else {%>
                                  
                                        
                                                <div class="addrs-box">
                                                    <input type="radio" id="address<%= index %>" name="address" value="<%= cart.useraddress._id %>" <% if (index === 0) { %> checked <% } %> >
                                                    <label for="address<%= index %>" class="text-dark"><%=cart.useraddress.name %>,<%=cart.useraddress.house %>,<span class="text-uppercase"><%=cart.useraddress.city %></span>,<span class="text-uppercase"><%=cart.useraddress.state %></span>,<%=cart.useraddress.pincode %>,<%=cart.useraddress.Country %>
                                                    <a href="/loadeditAddress/<%=cart.useraddress._id%>/<%=cart._id%>">Edit address</a></label><br>
                                                </div>
                                           
                                
                                    <% if (errorMessage.length > 0) { %>                
                                        <p style="color : red;"><%- errorMessage %></p>                    
                                    <% } %>                                    
                                    <a href="#" id="openModal" data-modal-target="#modal"><span class="icon icon-plus d-flex">&nbsp;<p>Add new address</p></span></a>
                                <%}%>




-->
				
			</div>
			<div class="card-body">
				<form action="/user/checkout">
					<div class="input-group form-group">
						<div class="input-group-prepend">
							<span class="input-group-text"><i class="fas fa-user"></i></span>
						</div>
						<input type="text" name="name" class="form-control" placeholder="name">
						
					</div>
					<div class="input-group form-group">
						<div class="input-group-prepend">
							<span class="input-group-text"><i class="fas fa-envelope"></i></span>
						</div>
						<input type="email" name="email" class="form-control" placeholder="email">
					</div>
                    <div class="input-group form-group">
						<div class="input-group-prepend">
							<span class="input-group-text"><i class="fas fa-mobile"></i></span>
						</div>
						<input type="text" name="mobile" class="form-control" placeholder="mobile">
					</div>
                    <div class="input-group form-group">
						<div class="input-group-prepend">
							<span class="input-group-text"><i class="fas fa-key"></i></span>
						</div>
						<input type="password" class="form-control" placeholder="password">
					</div>
                    <div class="input-group form-group">
						<div class="input-group-prepend">
							<span class="input-group-text"><i class="fas fa-key"></i></span>
						</div>
						<input type="password" name ="password" class="form-control" placeholder="confirm password">
					</div>
					<!-- <div class="row align-items-center remember">
						<input type="checkbox">Remember Me
					</div> -->
					<div class="form-group">
						<input type="submit" value="Signup" class="btn float-right login_btn">
					</div>
				</form>
			</div>
			<div class="card-footer">
				<div class="d-flex justify-content-center links">
					Already have an account?<a href="/user/login">Log In</a>
				</div>
				<!-- <div class="d-flex justify-content-center">
					<a href="#">Forgot your password?</a>
				</div> -->
			</div>
		</div>
	</div>
</div>

<%- include('../layout/authfooter') %>